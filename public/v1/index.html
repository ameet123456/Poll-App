<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Real-Time Poll App</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>tailwind.config = {darkMode: "class", theme: {extend: {colors: {primary: "#607AFB", "background-light": "#f5f6f8", "background-dark": "#0f1323"}, fontFamily: {display: "Lexend"}, borderRadius: {DEFAULT: "0.5rem", lg: "1rem", xl: "1.5rem", full: "9999px"}}}};</script>
<style>
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
  }
</style>
</head>
<body class="bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-dark group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<div class="px-4 md:px-10 lg:px-40 flex flex-1 justify-center py-5">
<div class="layout-content-container flex flex-col max-w-[960px] flex-1">

<!-- Header -->
<div class="flex flex-wrap justify-between gap-3 p-4">
<div class="flex min-w-72 flex-col gap-3">
<p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Real-Time Polls</p>
<p class="text-[#9b92c9] text-base font-normal leading-normal">Engage Your Audience</p>
</div>
</div>

<!-- Poll Creation -->
<div class="bg-[#1e1933] rounded-xl p-6 my-8 shadow-lg">
<h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Create a New Poll</h2>
<form id="createPollForm" class="flex max-w-[480px] flex-col gap-4 px-4 py-3">
<label class="flex flex-col min-w-40 flex-1">
<p class="text-white text-base font-medium leading-normal pb-2">Poll Question</p>
<input id="pollQuestion" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border border-[#3b3267] bg-[#141122] focus:border-[#3b3267] h-14 placeholder:text-[#9b92c9] p-[15px] text-base font-normal leading-normal" placeholder="Enter your poll question here" value=""/>
</label>
<div id="optionsContainer" class="flex flex-col gap-4">
  <div class="flex items-center gap-3 option-row">
    <input class="pollOption form-input flex-1 rounded-xl text-white border border-[#3b3267] bg-[#141122] p-3 placeholder:text-[#9b92c9]" placeholder="Option 1" value=""/>
    <button type="button" class="deleteOptionBtn text-red-500 hover:bg-red-700/20 p-2 rounded-full">
  <span class="material-symbols-outlined">delete</span>
</button>
  </div>
  <div class="flex items-center gap-3 option-row">
    <input class="pollOption form-input flex-1 rounded-xl text-white border border-[#3b3267] bg-[#141122] p-3 placeholder:text-[#9b92c9]" placeholder="Option 2" value=""/>
    <button type="button" class="deleteOptionBtn text-red-500 hover:bg-red-700/20 p-2 rounded-full">
  <span class="material-symbols-outlined">delete</span>
</button>
  </div>
</div>

<button type="button" id="addOptionBtn" class="flex items-center justify-center gap-2 rounded-xl h-10 px-4 bg-[#141122] border border-[#3b3267] text-white text-sm font-medium hover:border-primary transition-colors w-fit">
<span class="material-symbols-outlined" style="font-size: 20px;">add</span>
<span>Add Option</span>
</button>
<div class="flex justify-start pt-3">
<button type="submit" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 flex-1 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/80 transition-colors">
<span class="truncate">Create Poll</span>
</button>
</div>
</form>
</div>

<!-- Voting Section -->
<div id="pollSection" style="display:none;" class="bg-[#1e1933] rounded-xl p-6 my-8 shadow-lg">
<h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Vote on This Poll</h2>
<p id="pollQuestionText" class="text-white text-lg font-medium leading-normal px-4 pb-6"></p>
<form id="pollForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 py-3"></form>
</div>

<!-- Live Results -->
<div id="resultsSection" style="display:none;" class="bg-[#1e1933] rounded-xl p-6 my-8 shadow-lg">
<h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-5 pt-5">Live Results</h2>
<div id="resultsList" class="space-y-4 px-4 py-3"></div>
</div>

</div>
</div>
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const createPollForm = document.getElementById('createPollForm');
const pollSection = document.getElementById('pollSection');
const resultsSection = document.getElementById('resultsSection');
const pollQuestionText = document.getElementById('pollQuestionText');
const pollForm = document.getElementById('pollForm');
const resultsList = document.getElementById('resultsList');

const colors = ['bg-blue-500', 'bg-green-500', 'bg-orange-500', 'bg-red-500', 'bg-purple-500', 'bg-pink-500', 'bg-yellow-500', 'bg-indigo-500'];

let optionCount = 2;

// Add option button
document.getElementById('addOptionBtn').addEventListener('click', () => {
  optionCount++;
  const optionsContainer = document.getElementById('optionsContainer');

  const newOptionWrapper = document.createElement('div');
  newOptionWrapper.className = 'flex items-center gap-3 option-row';
  newOptionWrapper.innerHTML = `
    <input class="pollOption form-input flex-1 rounded-xl text-white border border-[#3b3267] bg-[#141122] p-3 placeholder:text-[#9b92c9]" placeholder="Option ${optionCount}" value=""/>
    <button type="button" class="deleteOptionBtn text-red-500 hover:bg-red-700/20 p-2 rounded-full">
  <span class="material-symbols-outlined">delete</span>
</button>
  `;
  optionsContainer.appendChild(newOptionWrapper);

  // Delete option listener
  newOptionWrapper.querySelector('.deleteOptionBtn').addEventListener('click', () => {
    newOptionWrapper.remove();
    optionCount--;
  });
});

// Create a new poll
createPollForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const question = document.getElementById('pollQuestion').value;
  const options = Array.from(document.querySelectorAll('.pollOption'))
                      .map(i => i.value)
                      .filter(o => o !== "");
  socket.emit('createPoll', { question, options });
});

// Update poll on the client
socket.on('updatePoll', (poll) => {
  if(poll.question === "") return;

  // Show poll sections
  pollSection.style.display = 'block';
  resultsSection.style.display = 'block';
  pollQuestionText.innerText = poll.question;

  // Render voting options
  pollForm.innerHTML = "";
  poll.options.forEach((opt, i) => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'bg-[#141122] p-4 rounded-xl border border-[#3b3267] hover:border-primary transition-colors cursor-pointer group';
    optionDiv.innerHTML = `
      <div class="flex justify-between items-center">
        <p class="text-white text-base">${opt}</p>
        <button type="button" class="vote-btn bg-primary/20 text-primary px-4 py-2 rounded-lg text-sm font-bold group-hover:bg-primary group-hover:text-white transition-colors" data-index="${i}">Vote</button>
      </div>
    `;
    pollForm.appendChild(optionDiv);
  });

  // Add vote button listeners
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      socket.emit('vote', btn.dataset.index);
    });
  });

  // Update results immediately
  updateResults(poll);
});

function updateResults(poll) {
  const votesArray = Object.values(poll.votes); // convert object â†’ array
  const total = votesArray.reduce((a, b) => a + b, 0);

  resultsList.innerHTML = "";
  
  poll.options.forEach((opt, i) => {
    const percentage = total > 0 ? Math.round((poll.votes[i] / total) * 100) : 0;
    const resultDiv = document.createElement('div');
    resultDiv.innerHTML = `
      <div>
        <div class="flex justify-between mb-1">
          <span class="text-base font-medium text-white">${opt}</span>
          <span class="text-sm font-medium text-white">${poll.votes[i]} votes (${percentage}%)</span>
        </div>
        <div class="w-full bg-[#141122] rounded-full h-2.5">
          <div class="${colors[i % colors.length]} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
        </div>
      </div>
    `;
    resultsList.appendChild(resultDiv);
  });
}
document.querySelectorAll('.deleteOptionBtn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.target.parentElement.remove();
      optionCount--;
    });
  });
</script>
</body>
</html>